<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Synaps.ing - Linked Markdown Notebooks</title>

<style>
  /* ========= Design Tokens ========= */
  :root{
    /* Palette (overridden by prefs) */
    --paper:#f2eee6; --paper-2:#ebe4d7; --paper-3:#e5dccb;
    --sheet:#fffdfa; --ink:#111; --red:#7a0000; --accent:#b40000;
    --line:rgba(0,0,0,.12);
    --shadow:0 10px 30px rgba(0,0,0,.10), 0 2px 8px rgba(0,0,0,.06);
    --radius:16px;
    --serif:"Georgia","Times New Roman",serif;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;

    /* Typography scale (11/13/15/18px) */
    --fs-11:0.6875rem;
    --fs-13:0.8125rem;
    --fs-15:0.9375rem;
    --fs-18:1.125rem;

    /* Editor ruling */
    --lines: lined;
    --rule-color:rgba(122,0,0,.07);

    /* Paper noise opacity (0..1) */
    --noise:.08;

    /* Optional background image (prefs) */
    --bg-image:none;
    --bg-size:cover;

    /* Rhythm */
    --pad-x:18px;
    --pad-y-topbar:10px;
    --pad-y-md:14px;    /* comfortable vertical padding */
    --pad-y-sm:10px;

    /* Stacks & chips */
    --stack-col-h:190px;
    --chip-h:28px;

    /* Buttons (px) */
    --btn-pad-y:6px;
    --btn-pad-x:10px;
    --btn-gap:7px;
    --btn-ic:14px;

    /* Chip background base */
    --chip-rgb:255,253,248;
    --chip-alpha:1; /* controlled by prefs */
  }

  /* Shared gutters */
  .topbar{ padding: var(--pad-y-topbar) var(--pad-x); }
  .wrap{ padding-left: var(--pad-x); padding-right: var(--pad-x); }
  .bottom-inner{ padding: var(--pad-y-sm) var(--pad-x); }
  .titlebar, .meta-row{ padding-left: var(--pad-x); padding-right: var(--pad-x); }
  textarea#md{ padding-left: var(--pad-x); padding-right: var(--pad-x); }
  .dialog{ padding: 14px var(--pad-x); }

  html,body{height:100%}
  body{
    margin:0; color:var(--ink); font-family:var(--serif);
    background: var(--paper);
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    position:relative; z-index:0;
  }
  input, button, select, textarea { font-family: var(--serif); }

  /* Optional full-bleed background image mode (disables paper noise) */
  body.bg-image-on{ background: transparent; }
  body.bg-image-on::after{
    content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
    background-image: var(--bg-image);
    background-size: var(--bg-size);
    background-position:center center; background-repeat:no-repeat;
    opacity:1;
  }
  body::before{
    content:""; position:fixed; inset:0; pointer-events:none; z-index:1;
    background-image:
      radial-gradient(rgba(0,0,0,var(--noise)) 1px, transparent 1px),
      url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAAAQCAYAAAB1Gk9kAAAAdElEQVR4nO2WsQkCMQwDPc6c8C5woaYwXwS2d8yqCq1rj+f4+o2y0qY6nJrjS/8B8QyqHq7WZsR8fT3h9c4hF0+qM4JQ6sI+8d7b2rT7l5fQ0VtQy8sH0Zl7U0o0hCj+Y9h0l3A7d0fQ1v8h5q0j6g0rWcQm6e+5kLw/C7H8c4sH1Fz3q9L5k1pD9W8Q7S0oHkqM7V1vHcQ5Y5nVvQw==');
    background-size: 6px 6px, 128px 32px;
    mix-blend-mode:multiply; opacity:1;
  }
  body.bg-image-on::before{ display:none; }

  /* Minimal scrollbars */
  .scroll-minimal{ scrollbar-width: thin; scrollbar-color: rgba(0,0,0,.25) transparent; }
  .scroll-minimal::-webkit-scrollbar{ width:0; height:0; }
  .scroll-minimal:hover::-webkit-scrollbar{ width:8px; height:8px; }
  .scroll-minimal::-webkit-scrollbar-thumb{ background: rgba(0,0,0,.25); border-radius:8px; }
  .scroll-minimal::-webkit-scrollbar-track{ background: transparent; }

  /* Range slider */
  input[type="range"]{ -webkit-appearance:none; appearance:none; width:100%; background:transparent; height:22px; }
  input[type="range"]::-webkit-slider-runnable-track{ height:2px; background: rgba(0,0,0,.2); border-radius:2px; }
  input[type="range"]::-moz-range-track{ height:2px; background: rgba(0,0,0,.2); border-radius:2px; }
  input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none; appearance:none; width:12px; height:12px; border-radius:50%;
    background: var(--accent); margin-top:-5px; cursor:pointer;
  }
  input[type="range"]::-moz-range-thumb{ width:12px; height:12px; border:none; border-radius:50%; background: var(--accent); cursor:pointer; }

  /* ========= Top Bar ========= */
  .topbar{
    position:sticky; top:0; z-index:100;
    display:grid; grid-template-columns: 1fr auto; align-items:center;
    gap:10px; border-bottom:1px solid var(--line);
    background:linear-gradient(180deg, color-mix(in oklab, var(--paper) 96%, white), color-mix(in oklab, var(--paper) 88%, white));
    backdrop-filter:saturate(1.05) blur(6px);
  }
  .left-controls{ display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; min-width:0 }
  .brand{font-weight:700; letter-spacing:.25px; font-size:var(--fs-18); white-space:nowrap; display:flex; align-items:center; gap:.5rem}
  .logo-main{ color:#000; }     /* black "Synaps" */
  .logo-dot{ color:var(--accent); } /* red ".ing" */

  .stack-center{display:flex; gap:.35rem; flex-wrap:wrap; align-items:center}
  .crumb{padding:.15rem .5rem;border:1px solid var(--line);border-radius:999px;background:var(--sheet);cursor:pointer; font-size:var(--fs-11); white-space:nowrap}

  .select,.input{
    font-size:var(--fs-13);
    border:1px solid var(--line); border-radius:10px; background:var(--sheet);
    padding:.35rem .55rem; white-space:nowrap
  }
  .btn{
    font-size:var(--fs-13);
    border:1px solid var(--line); border-radius:10px; background:var(--sheet); white-space:nowrap;
    padding:var(--btn-pad-y) var(--btn-pad-x); cursor:pointer; display:inline-flex; align-items:center; gap:var(--btn-gap);
  }
  .btn:hover{border-color:var(--accent)}
  .btn.primary{border-color:var(--accent)}
  .btn .ic{width:var(--btn-ic); height:var(--btn-ic); display:inline-flex}
  .btn .ic svg{width:100%; height:100%}
  .btn .label{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

  .searchbox{display:flex; justify-content:flex-end; gap:.5rem; align-items:center; min-width:0}
  .searchbox input[type="search"]{
    flex: 1 1 28ch; min-width: 20ch; max-width: min(44ch, 60%);
    padding:.45rem .75rem;border-radius:999px;border:1px solid var(--line);background:var(--sheet);outline:none; font-size:var(--fs-13)
  }
  .searchbox input:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(180,0,0,.12)}
  .switch{
    display:inline-flex; align-items:center; gap:.35rem; padding:.3rem .55rem; border-radius:999px; border:1px solid var(--line); background:var(--sheet); cursor:pointer; font-size:var(--fs-13)
  }
  .switch input{accent-color:var(--accent)}
  .hidden{display:none}

  /* ========= Layout ========= */
  .wrap{max-width:1300px;margin:20px auto calc(240px + 2rem);display:grid;grid-template-columns:280px 1fr 280px;gap:18px; position:relative; z-index:2}

  /* ========= Left: Front card (meta) ========= */
  .front-card{
    background:var(--sheet); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);
    overflow:hidden; display:flex; flex-direction:column; min-height:260px;
  }
  .front-head{padding:10px 12px; border-bottom:1px dashed var(--line); display:flex; align-items:center; gap:.6rem}
  .id-badge{margin-left:auto; font-weight:700; opacity:.85; font-size:var(--fs-13)}
  .front-body{padding:10px 12px; display:grid; gap:8px}
  .chip{display:inline-block; padding:.2rem .5rem; border:1px solid var(--line); border-radius:999px; background:var(--sheet); white-space:nowrap; font-size:var(--fs-11)}
  .front-section{padding:10px 12px; border-top:1px dashed var(--line)}
  .front-section h4{margin:0 0 .4rem 0; font-size:var(--fs-13)}
  .hierarchy{font-size:var(--fs-13)}
  .hierarchy .link{cursor:pointer; color:var(--red); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%}

  /* ========= Center: Back card (editor) ========= */
  .back-card{
    background:var(--sheet); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);
    overflow:hidden; display:flex; flex-direction:column; min-height:560px;
  }
  .titlebar{
    display:flex; align-items:center; gap:.6rem; border-bottom:1px solid var(--line);
    background:linear-gradient(180deg,var(--sheet),color-mix(in oklab, var(--sheet) 75%, transparent));
    padding: var(--pad-y-md) var(--pad-x);
  }
  .titlebar input.title{flex:1; font:700 var(--fs-18) var(--serif); border:none; outline:none; background:transparent}
  .meta-row{
    display:flex; flex-wrap:wrap; gap:.6rem .6rem; align-items:center; border-bottom:1px dashed var(--line); background:var(--sheet);
    font-size:var(--fs-13); padding: var(--pad-y-md) var(--pad-x);
  }
  .meta-row label{opacity:.95; display:flex; gap:.4rem; align-items:center}
  .meta-row input, .meta-row select{font:400 var(--fs-13) var(--serif); border:1px solid var(--line); padding:.4rem .6rem; border-radius:10px; background:var(--sheet); outline:none}
  .meta-row input:focus, .meta-row select:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(180,0,0,.12)}
  .editor-pane{position:relative; flex:1; display:flex; min-height:420px;}
  textarea#md{
    width:100%; height:100%; border:0; outline:none; resize:none; padding: var(--pad-y-md) var(--pad-x);
    font:var(--fs-15)/1.6 var(--serif);
    background:var(--sheet);
    background-image: var(--editor-bg);
    background-size: var(--editor-bg-size, auto);
  }
  .helper{position:absolute; inset: auto var(--pad-x) var(--pad-y-md) auto; font-size:var(--fs-11); opacity:.7;}

  /* Popover (kept only for link disambiguation) */
  .popover{
    position:fixed; z-index:200; background:var(--sheet); border:1px solid var(--line); border-radius:10px; box-shadow:var(--shadow);
    min-width:200px; max-height:220px; overflow:auto; padding:6px; display:none;
  }
  .popover.open{ display:block; }
  .menu-item{ padding:.35rem .5rem; border-radius:8px; cursor:pointer; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .menu-item:hover{ background:rgba(0,0,0,.05); }

  /* ========= Right rail ========= */
  .right-rail{display:grid; gap:14px}
  .blk{
    background:var(--sheet); border:1px solid var(--line); border-radius:var(--radius);
    display:flex; align-items:center; justify-content:center; min-height:110px;
    box-shadow:var(--shadow);
  }
  .blk .btn{font-weight:600}

  /* ========= Bottom: All stacks ========= */
  .bottombar{
    position:fixed; left:0; right:0; bottom:0; z-index:3; border-top:1px solid var(--line);
    background:linear-gradient(180deg, color-mix(in oklab, var(--paper) 94%, white), color-mix(in oklab, var(--paper) 98%, white));
  }
  .bottom-inner{max-width:1300px; margin:0 auto;}
  .tools-row{display:flex; align-items:center; gap:.5rem; margin-bottom:6px; flex-wrap:wrap}
  .tools-row .hint{font-size:var(--fs-11); opacity:.8; white-space:nowrap}
  .stacks-row{ display:block; overflow-x:auto; padding-bottom:10px; white-space:nowrap; }

  .stack-col{
    position:relative; display:inline-block; vertical-align:top;
    width:260px; height:var(--stack-col-h); margin-right:18px;
    background:var(--paper-2);
    border:1px solid var(--line); border-radius:14px; box-shadow:var(--shadow);
    padding:8px 10px; overflow:hidden;
  }
  .stack-col:nth-child(3n+2){background:var(--paper-3)}
  .stack-col:nth-child(3n+3){background:var(--paper)}
  .stack-col.drop-target{ outline:2px dashed color-mix(in oklab, var(--accent) 55%, transparent); outline-offset:-6px; }

  .stack-col .shead{
    position:sticky; top:0; z-index:2;
    display:flex; justify-content:space-between; align-items:center;
    font-weight:700; margin-bottom:6px; font-size:var(--fs-13);
    border-bottom:1px dashed var(--line); padding-bottom:6px;
    background:transparent;
  }
  .stack-col .shead .stitle{
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:70%;
    cursor:text;
  }
  .stack-col .shead .stack-title-input{
    font:700 var(--fs-13) var(--serif);
    border:1px solid var(--line); border-radius:8px; background:var(--sheet);
    padding:.2rem .4rem; width:70%;
  }
  .stack-col .shead .count{font-weight:400; opacity:.85}

  .stack-col .pile{
    position:relative; width:100%;
    height:calc(var(--stack-col-h) - 44px);
    overflow-y:auto; overflow-x:hidden;
    -webkit-overflow-scrolling:touch;
    padding-right:6px;
  }
  .stack-col .pile.scroll-minimal{ scrollbar-width:thin; scrollbar-color: rgba(0,0,0,.28) transparent; }
  .stack-col .pile.scroll-minimal::-webkit-scrollbar{ width:0; height:0; }
  .stack-col:hover .pile.scroll-minimal::-webkit-scrollbar{ width:8px; height:8px; }
  .stack-col .pile.scroll-minimal::-webkit-scrollbar-thumb{ background:rgba(0,0,0,.28); border-radius:8px; }
  .stack-col .pile.scroll-minimal::-webkit-scrollbar-track{ background:transparent; }
  .stack-col .pile::before,
  .stack-col .pile::after{
    content:""; position:absolute; left:0; right:0; height:12px; pointer-events:none; z-index:1;
    opacity:0; transition:opacity .15s ease;
  }
  .stack-col .pile::before{ top:0; background:linear-gradient(to bottom, rgba(0,0,0,.12), rgba(0,0,0,0)); }
  .stack-col .pile::after{ bottom:0; background:linear-gradient(to top, rgba(0,0,0,.12), rgba(0,0,0,0)); }
  .stack-col .pile.scrolled-mid::before,
  .stack-col .pile.scrolled-mid::after{ opacity:.35; }
  .stack-col .pile.scrolled-top::after{ opacity:.35; }
  .stack-col .pile.scrolled-bottom::before{ opacity:.35; }
  .pile-sizer{ width:1px; height:0; }

  .note-chip{
    position:absolute; left:0; right:0;
    height:var(--chip-h); padding:0 10px; border-radius:10px; border:1px solid var(--line);
    background: rgba(var(--chip-rgb), var(--chip-alpha));
    display:flex; justify-content:space-between; align-items:center;
    font-size:var(--fs-13); box-shadow:0 6px 14px rgba(0,0,0,.08);
    cursor:pointer; transition:transform .15s ease, box-shadow .15s ease, left .15s ease, opacity .15s ease;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis; user-select:none;
  }
  .note-chip[draggable="true"]{ cursor:grab; }
  .note-chip.dragging{ opacity:.6; cursor:grabbing; }
  .note-chip span.title{overflow:hidden; text-overflow:ellipsis; white-space:nowrap; padding-right:8px; font-weight:600}
  .note-chip span.hid{font-weight:700; opacity:.85}
  .note-chip:hover{transform:translateY(-2px); box-shadow:0 10px 18px rgba(0,0,0,.12)}
  .note-chip.active{outline:2px solid rgba(180,0,0,.18)}
  .note-chip.drop-target{ outline:2px dashed rgba(180,0,0,.35); outline-offset:-3px; }
  .depth-0{left:0}
  .depth-1{left:10px}
  .depth-2{left:20px}
  .depth-3{left:30px}

  /* Transparent chip mode */
  body.chips-translucent .note-chip{
    background: rgba(255,255,255, .14);
    border-color: transparent;
    box-shadow:none;
  }
  body.chips-translucent .note-chip.active{
    outline:none;
    box-shadow: inset 0 0 0 2px rgba(0,0,0,.22);
  }

/* ===== Accent-styled links (leave .btn alone) ===== */
a:not(.btn),
a:not(.btn):visited{
  color: var(--accent);
  text-decoration: none;
  border-bottom: 1px dotted currentColor;
}

a:not(.btn):hover{
  color: color-mix(in oklab, var(--accent) 85%, black);
  border-bottom-style: solid;
}

a:focus-visible{
  outline: 2px solid color-mix(in oklab, var(--accent) 55%, white);
  outline-offset: 2px;
  border-radius: 6px;
}
  
  /* ========= Modals ========= */
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.25); display:none; align-items:center; justify-content:center; z-index:190; }
  .modal.open{display:flex}
  .dialog{ width:min(720px, 92vw); background:var(--sheet); border:1px solid var(--line); border-radius:14px; box-shadow:var(--shadow); position:relative; }
  .dialog h3{margin:0 0 8px; font-size:var(--fs-18)}
  .row{display:grid; grid-template-columns:180px 1fr; gap:10px; align-items:center; margin:8px 0; font-size:var(--fs-13)}
  .actions{display:flex; justify-content:flex-end; gap:.5rem; margin-top:10px}

  @media (max-width:1100px){
    .wrap{grid-template-columns:1fr}
    .right-rail{order:3}
    .searchbox input[type="search"]{ min-width:18ch; }
  }

  /* ===== Mobile blocker (cheeky) ===== */
#mobileBlocker{
  position: fixed; inset: 0; z-index: 9999;
  display: none; /* default off */
  align-items: center; justify-content: center;
  background:
    radial-gradient(1000px 600px at 50% 0%, rgba(0,0,0,.06), rgba(0,0,0,.10)),
    #fff; /* clean, no paper texture */
  color: var(--ink);
  text-align: center;
  padding: 24px;
}
#mobileBlocker .card{
  width: min(90vw, 520px);
  background: var(--sheet);
  border: 1px solid var(--line);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 18px;
}
#mobileBlocker h1{
  margin: 0 0 .5rem;
  font: 700 1.25rem var(--serif);
  color: var(--accent);
}
#mobileBlocker p{ margin: .35rem 0; line-height: 1.5 }

/* Show blocker on small viewports OR coarse-pointer devices (most phones) */
@media (max-width: 820px), (pointer: coarse) and (hover: none){
  #mobileBlocker{ display: flex; }
  /* Optional: soften the UI behind it without risking layout shifts */
  body > *:not(#mobileBlocker){ filter: blur(2px); pointer-events: none; user-select: none; }
}

/* Never show in print */
@media print{
  #mobileBlocker{ display: none !important; }
}
  
</style>
</head>
<body class="scroll-minimal">
<!-- Mobile blocker -->
<div id="mobileBlocker" role="dialog" aria-live="polite" aria-label="Not mobile friendly">
  <div class="card">
    <h1>sorry — not mobile friendly</h1>
    <p>i'm too lazy to make responsive, so get off your phone ;)</p>
    <p style="opacity:.7; font-size:.95em">open on a tablet/desktop to continue.</p>
  </div>
</div>

<!-- ===== Inline Icons ===== -->
<svg width="0" height="0" style="position:absolute;visibility:hidden">
  <symbol id="i-filter" viewBox="0 0 24 24"><path d="M3 5h18M6 12h12M10 19h4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></symbol>
  <symbol id="i-export" viewBox="0 0 24 24"><path d="M12 3v12m0-12 4 4m-4-4-4 4M5 21h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></symbol>
  <symbol id="i-import" viewBox="0 0 24 24"><path d="M12 21V9m0 12 4-4m-4 4-4-4M5 3h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></symbol>
  <symbol id="i-theme" viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9 4 4 0 0 1-4-4 4 4 0 0 1-5-5Z" stroke="currentColor" stroke-width="2" fill="none"/></symbol>
  <symbol id="i-save" viewBox="0 0 24 24"><path d="M5 21h14V7l-4-4H5v18Zm4-1v-6h6v6M6 7h9" stroke="currentColor" stroke-width="2" fill="none"/></symbol>
  <symbol id="i-dup" viewBox="0 0 24 24"><path d="M8 8h11v11H8zM5 5h11v11H5z" stroke="currentColor" stroke-width="2" fill="none"/></symbol>
  <symbol id="i-plus" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></symbol>
  <symbol id="i-trash" viewBox="0 0 24 24"><path d="M4 7h16M9 7V5h6v2m-8 0 1 12h8l1-12" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></symbol>
  <symbol id="i-note-export" viewBox="0 0 24 24"><path d="M6 3h9l3 3v12a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3V6a3 3 0 0 1 3-3Zm6 7v8m0-8 3 3m-3-3-3 3" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></symbol>
</svg>

<!-- ===== Top Bar (brand + download + stacks on left; search on right) ===== -->
<header class="topbar">
  <div class="left-controls">
    <div class="brand">
      <span class="logo"><span class="logo-main">Synaps</span><span class="logo-dot">.ing</span></span>
    </div>

    <a href="./book" class="btn" id="openBookBtn" title="Book Builder">
      <span class="ic"><svg><use xlink:href="#i-export"/></svg></span>
      <span class="label">Book</span>
    </a>

    <a id="downloadApp" class="btn" title="Download this app as a single HTML file">
      <span class="ic"><svg><use xlink:href="#i-export"/></svg></span>
      <span class="label">Download synaps.ing</span>
    </a>

    <select id="stackSelector" class="select" title="Current stack"></select>
    <button id="addStackBtn" class="btn"><span class="ic"><svg><use xlink:href="#i-plus"/></svg></span><span class="label">Stack</span></button>
    <nav class="stack-center" id="breadcrumb"></nav>
  </div>

  <div class="searchbox">
    <input id="search" type="search" placeholder="Search…"/>
    <label class="switch"><input type="checkbox" id="filterMode"> Filter</label>
    <label class="switch"><input type="checkbox" id="chipTransparent"> Transparent</label>
    <button id="exportBtn" class="btn"><span class="ic"><svg><use xlink:href="#i-export"/></svg></span><span class="label">Export</span></button>
    <button id="importBtn" class="btn"><span class="ic"><svg><use xlink:href="#i-import"/></svg></span><span class="label">Import</span></button>
    <input id="importInput" type="file" accept="application/json" class="hidden"/>
    <button id="newNotebookBtn" class="btn"><span class="ic"><svg><use xlink:href="#i-plus"/></svg></span><span class="label">New Notebook</span></button>
    <button id="prefsBtn" class="btn"><span class="ic"><svg><use xlink:href="#i-theme"/></svg></span><span class="label">Theme</span></button>
  </div>
</header>

<!-- ===== Main ===== -->
<main class="wrap">
  <!-- Left: Front (meta) -->
  <aside class="front-card" id="frontCard">
    <div class="front-head">
      <input id="frontTitle" class="input" placeholder="Note Title" style="border:none; outline:none; background:transparent; font-weight:700; width:70%"/>
      <span class="id-badge" id="frontId">—</span>
    </div>
    <div class="front-body" id="frontMeta">
      <span class="chip" id="chipStack">stack: Inbox</span>
      <span class="chip" id="chipCreated">created: —</span>
      <span class="chip" id="chipModified">modified: —</span>
      <div id="chipTags"></div>
    </div>
    <div class="front-section">
      <h4>Notebook hierarchy</h4>
      <div class="hierarchy" id="hierarchy">
        <div class="subtle">No links yet.</div>
      </div>
    </div>
  </aside>

  <!-- Center: Editor -->
  <section class="back-card">
    <div class="titlebar">
      <input id="titleInput" class="title" placeholder="Untitled note"/>
      <button class="btn" id="duplicateBtn"><span class="ic"><svg><use xlink:href="#i-dup"/></svg></span><span class="label">Duplicate</span></button>
      <button class="btn" id="exportNoteBtn"><span class="ic"><svg><use xlink:href="#i-note-export"/></svg></span><span class="label">Export</span></button>
      <button class="btn" id="deleteBtn"><span class="ic"><svg><use xlink:href="#i-trash"/></svg></span><span class="label">Delete</span></button>
      <button class="btn primary" id="saveBtn"><span class="ic"><svg><use xlink:href="#i-save"/></svg></span><span class="label">Save</span></button>
    </div>

    <div class="meta-row" id="metaRow">
      <label>Stack
        <select id="stackSelectMeta" class="select" title="Note stack"></select>
      </label>

      <label>Parent
        <select id="parentSelectMeta" class="select" title="Parent note (same stack)"></select>
      </label>

      <label>Tags <input id="tagsInput" class="input" placeholder="comma,separated,tags"/></label>
      <span style="margin-left:auto" class="subtle">Created: <span id="createdMeta">—</span></span>
      <span class="subtle">Modified: <span id="modifiedMeta">—</span></span>

      <!-- kept for disambiguating [[links]] only -->
      <div id="linkPicker" class="popover"></div>
    </div>

    <div class="editor-pane">
      <textarea id="md" class="scroll-minimal" spellcheck="false" placeholder="# Start writing…

• Use [[Note Title]] to link or create (sibling).
• Use >>Subnote>> to create a subnote (child).
• IDs: stack.note.child.subchild → e.g., 1.233.433

Ctrl/Cmd+S save · Cmd/Ctrl+D duplicate · Cmd/Ctrl+E export note · Cmd/Ctrl+Backspace delete
Cmd/Ctrl+F search · Cmd/Ctrl+Shift+F toggle filter · Cmd/Ctrl+Alt+T toggle transparency"></textarea>
      <div class="helper">[[…]] and >>…>> autocomplete</div>
    </div>
  </section>

  <!-- Right rail -->
  <aside class="right-rail">
    <div class="blk"><button id="newNoteBtn" class="btn"><span class="ic"><svg><use xlink:href="#i-plus"/></svg></span><span class="label">New Note</span></button></div>
    <div class="blk"><button id="newSubBtn" class="btn"><span class="ic"><svg><use xlink:href="#i-plus"/></svg></span><span class="label">New Subnote</span></button></div>
    <div class="blk"><button id="newStackBtn" class="btn"><span class="ic"><svg><use xlink:href="#i-plus"/></svg></span><span class="label">New Stack</span></button></div>
  </aside>
</main>

<!-- ===== Bottom: All stacks ===== -->
<footer class="bottombar">
  <div class="bottom-inner">
    <div class="tools-row">
      <span class="hint">All stacks shown · Double-click a stack title to rename · Double-click a stack column to focus · Drag notes between stacks · Click a card to open</span>
    </div>
    <div class="stacks-row scroll-minimal" id="stacksRow"></div>
  </div>
</footer>

<!-- ===== Export Notebook Modal ===== -->
<div id="exportMenu" class="modal">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="expTitle">
    <h3 id="expTitle">Export Notebook</h3>
    <div class="row">
      <label>Format</label>
      <div>
        <label><input type="radio" name="expfmt" value="json" checked> JSON (single file)</label><br/>
        <label><input type="radio" name="expfmt" value="mdzip"> Markdown (.zip with .md files)</label>
      </div>
    </div>
    <div class="row">
      <label>Scope</label>
      <div>
        <label><input type="radio" name="expscope" value="all" checked> All stacks</label><br/>
        <label><input type="radio" name="expscope" value="current"> Current stack only</label>
      </div>
    </div>
    <div class="row">
      <label>Safe filenames</label>
      <div>
        <label><input type="checkbox" id="expSafe" checked> ASCII-only names (helps avoid OS warnings)</label>
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="expCancel"><span class="ic"><svg><use xlink:href="#i-import"/></svg></span><span class="label">Cancel</span></button>
      <button class="btn primary" id="expGo"><span class="ic"><svg><use xlink:href="#i-export"/></svg></span><span class="label">Export</span></button>
    </div>
  </div>
</div>

<!-- ===== Preferences ===== -->
<div id="prefsMenu" class="modal">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="prefTitle">
    <h3 id="prefTitle">Theme & Preferences</h3>

    <div class="row">
      <label for="prefPaper">Paper tone</label>
      <select id="prefPaper" class="select">
        <option value="parchment">Parchment</option>
        <option value="crisp">Crisp</option>
        <option value="lavender">Lavender</option>
        <option value="moss">Moss</option>
      </select>
    </div>

    <div class="row">
      <label for="prefLines">Line style</label>
      <select id="prefLines" class="select">
        <option value="unruled">Unruled</option>
        <option value="lined" selected>Lined</option>
        <option value="dots">Dots</option>
        <option value="grid">Grid</option>
      </select>
    </div>

    <div class="row">
      <label for="prefFont">Text size</label>
      <select id="prefFont" class="select">
        <option value="sm">Small</option>
        <option value="md" selected>Medium</option>
        <option value="lg">Large</option>
      </select>
    </div>

    <div class="row">
      <label for="prefSerif">Serif font</label>
      <input id="prefSerif" class="input" placeholder="e.g., Georgia, 'Times New Roman', serif"/>
    </div>
    <div class="row">
      <label for="prefMono">Mono font</label>
      <input id="prefMono" class="input" placeholder="e.g., ui-monospace, Menlo, Consolas, 'Courier New', monospace"/>
    </div>

    <div class="row">
      <label>Colors</label>
      <div style="display:flex; gap:.5rem; flex-wrap:wrap">
        <label>Ink <input id="prefInk" type="color" value="#111111" class="input" style="padding:.2rem .3rem; width:84px"/></label>
        <label>Accent <input id="prefAccent" type="color" value="#b40000" class="input" style="padding:.2rem .3rem; width:84px"/></label>
        <label>Red <input id="prefRed" type="color" value="#7a0000" class="input" style="padding:.2rem .3rem; width:84px"/></label>
      </div>
    </div>

    <div class="row">
      <label for="prefNoise">Paper grain</label>
      <input type="range" id="prefNoise" min="0" max="0.25" step="0.01"/>
    </div>

    <div class="row">
      <label>Background image</label>
      <div style="display:grid; gap:.5rem">
        <input id="prefBgUrl" class="input" placeholder="Paste image URL (https://...)"/>
        <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap">
          <label>Size
            <select id="prefBgSize" class="select">
              <option value="cover" selected>Cover</option>
              <option value="contain">Contain</option>
            </select>
          </label>
          <button class="btn" id="prefBgClear"><span class="ic"><svg><use xlink:href="#i-import"/></svg></span><span class="label">Clear</span></button>
        </div>
      </div>
    </div>

    <div class="row">
      <label>Theme JSON</label>
      <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap">
        <button class="btn" id="themeExport"><span class="ic"><svg><use xlink:href="#i-export"/></svg></span><span class="label">Export Theme</span></button>
        <button class="btn" id="themeImportBtn"><span class="ic"><svg><use xlink:href="#i-import"/></svg></span><span class="label">Import Theme</span></button>
        <input id="themeImport" type="file" accept="application/json" class="hidden"/>
      </div>
    </div>

    <div class="actions">
      <button class="btn" id="prefCancel"><span class="ic"><svg><use xlink:href="#i-import"/></svg></span><span class="label">Cancel</span></button>
      <button class="btn primary" id="prefSave"><span class="ic"><svg><use xlink:href="#i-save"/></svg></span><span class="label">Save</span></button>
      <button class="btn" id="prefReset"><span class="ic"><svg><use xlink:href="#i-import"/></svg></span><span class="label">Reset</span></button>
    </div>
  </div>
</div>

<script>
/* ============================================================
   Synaps.ing — Dropdown refactor + top-bar stack as source of truth
   ============================================================ */
(function(){
  "use strict";

  /* ---------- IDs & helpers ---------- */
  const id = (x)=>document.getElementById(x);
  const $  = (sel,root=document)=>root.querySelector(sel);
  const nowISO = ()=>new Date().toISOString();
  const fmt = (iso)=> iso ? new Date(iso).toLocaleString() : '—';
  const uid = ()=> `${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;
  const escapeHTML = s => String(s).replace(/[&<>]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[c]));
  const safeName = (s, asciiOnly=true)=>{
    const base = (s||'').toString();
    const cleaned = asciiOnly ? base.normalize('NFKD').replace(/[^\x20-\x7E]+/g,'') : base;
    return cleaned.replace(/[^\w\-\.\/]+/g,'_').replace(/_+/g,'_').replace(/^_+|_+$/g,'');
  };
  const parseTags = (s)=> !s ? [] : Array.isArray(s) ? s : String(s).split(',').map(t=>t.trim()).filter(Boolean);
  function download(name, blob){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  }
  function flash(btn,text){
    const label = btn.querySelector('.label');
    const old = label ? label.textContent : btn.textContent;
    if(label) label.textContent = text; else btn.textContent = text;
    btn.disabled = true;
    setTimeout(()=>{ if(label) label.textContent = old; else btn.textContent = old; btn.disabled=false; }, 900);
  }

  /* ---------- App state ---------- */
  const LS_KEY='synapsing_notes_v6'; const PREFS_KEY='synapsing_prefs_v5'; const VERSION=6;
  const state = { currentId:null, notes:[], stacks:[], selectedStack:null, filterMode:false };

  function saveAll(){ localStorage.setItem(LS_KEY, JSON.stringify({version:VERSION, notes:state.notes, stacks:state.stacks})); }
  function stacksUnique(){ state.stacks = Array.from(new Set(state.stacks)); }
  function getNote(nid){ return state.notes.find(n=>n.id===nid); }
  function listByStack(stack){ return state.notes.filter(n=> (n.stack||'Inbox') === (stack||'Inbox')).sort((a,b)=> (a.order||0)-(b.order||0)); }
  function listChildren(parentId){ return state.notes.filter(n=> n.parentId===parentId).sort((a,b)=> (a.order||0)-(b.order||0)); }
  function listTopLevel(stack){ return state.notes.filter(n=> n.stack===stack && !n.parentId).sort((a,b)=> (a.order||0)-(b.order||0)); }
  function stackIndex(stack){ return state.stacks.indexOf(stack)+1; }
  function nextOrderFor(parentId, stack){
    const pool = parentId ? listChildren(parentId) : listTopLevel(stack);
    const max = pool.reduce((m,n)=> Math.max(m, n.order||0), 0);
    return max+1;
  }
  function renumberGroup(parentId, stack){
    const sibs = state.notes
      .filter(n => n.stack===stack && (parentId ? n.parentId===parentId : !n.parentId))
      .sort((a,b)=> (a.order||0)-(b.order||0));
    sibs.forEach((n,i)=> n.order = i+1);
    saveAll();
  }
  function hierarchicalId(n){
    if(!n) return '—';
    const parts = [stackIndex(n.stack)];
    const lineage = [];
    let cur = n;
    while(cur){
      const siblings = cur.parentId ? listChildren(cur.parentId) : listTopLevel(cur.stack);
      const idx = siblings.findIndex(x=>x.id===cur.id) + 1;
      lineage.push(idx);
      cur = cur.parentId ? getNote(cur.parentId) : null;
    }
    return parts.concat(lineage.reverse()).join('.');
  }

  function createNote(part={}, silent=false){
    const created = nowISO();
    const stack = (part.stack||state.selectedStack||'Inbox');
    if(!state.stacks.includes(stack)) state.stacks.push(stack);
    stacksUnique();
    const note = {
      id: uid(),
      title: (part.title||'Untitled').trim() || 'Untitled',
      content: part.content||'',
      created, modified: created,
      stack,
      tags: parseTags(part.tags||[]),
      parentId: part.parentId || null,
      order: nextOrderFor(part.parentId||null, stack)
    };
    state.notes.push(note);
    if(!silent){ state.currentId = note.id; state.selectedStack = note.stack; saveAll(); }
    return note;
  }
  function updateNote(id, fields){
    const n = getNote(id); if(!n) return;
    const prevStack = n.stack;
    Object.assign(n, fields);
    if(fields.stack && fields.stack !== prevStack){
      if(!state.stacks.includes(fields.stack)) state.stacks.push(fields.stack);
      if(!n.parentId) n.order = nextOrderFor(null, n.stack);
      state.selectedStack = n.stack;
    }
    n.modified = nowISO(); stacksUnique(); saveAll(); return n;
  }
  function duplicateNote(nid){
    const n = getNote(nid); if(!n) return;
    return createNote({ title:n.title+' (copy)', content:n.content, stack:n.stack, tags:n.tags.slice(), parentId:n.parentId });
  }

  /* ---------- Elements ---------- */
  const els = {
    // Top bar
    stackSelector: id('stackSelector'), addStackBtn: id('addStackBtn'),
    breadcrumb: id('breadcrumb'), search: id('search'), filterMode: id('filterMode'),
    chipTransparent: id('chipTransparent'),
    exportBtn: id('exportBtn'), exportMenu: id('exportMenu'), expCancel:id('expCancel'), expGo:id('expGo'), expSafe:id('expSafe'),
    importBtn:id('importBtn'), importInput: id('importInput'),
    prefsBtn: id('prefsBtn'), prefsMenu: id('prefsMenu'), prefCancel:id('prefCancel'), prefSave:id('prefSave'),
    // Prefs fields
    prefPaper: id('prefPaper'), prefLines: id('prefLines'), prefFont: id('prefFont'),
    prefSerif: id('prefSerif'), prefMono:id('prefMono'), prefInk:id('prefInk'), prefAccent:id('prefAccent'), prefRed:id('prefRed'),
    prefNoise: id('prefNoise'),
    prefBgUrl:id('prefBgUrl'), prefBgSize:id('prefBgSize'), prefBgClear:id('prefBgClear'),
    themeExport:id('themeExport'), themeImport:id('themeImport'), themeImportBtn:id('themeImportBtn'),
    // Editor
    titleInput: id('titleInput'), tagsInput: id('tagsInput'),
    stackSelectMeta: id('stackSelectMeta'), parentSelectMeta: id('parentSelectMeta'),
    md: id('md'),
    createdMeta: id('createdMeta'), modifiedMeta: id('modifiedMeta'),
    saveBtn: id('saveBtn'), duplicateBtn: id('duplicateBtn'), deleteBtn:id('deleteBtn'), exportNoteBtn:id('exportNoteBtn'),
    newNoteBtn: id('newNoteBtn'), newSubBtn: id('newSubBtn'), newStackBtn: id('newStackBtn'),
    frontTitle: id('frontTitle'), frontId: id('frontId'), chipStack: id('chipStack'), chipCreated: id('chipCreated'), chipModified: id('chipModified'), chipTags: id('chipTags'),
    hierarchy: id('hierarchy'),
    stacksRow: id('stacksRow'),
    newNotebookBtn: id('newNotebookBtn'),
    prefReset: id('prefReset'),
    linkPicker: id('linkPicker'),
    downloadApp: id('downloadApp')
  };

  /* ---------- Preferences ---------- */
  function loadPrefs(){
    const def = {
      paper:'parchment', lines:'lined', font:'md', noise:.08,
      serif:"Georgia, 'Times New Roman', serif",
      mono:"ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace",
      colors:{ ink:'#111111', accent:'#b40000', red:'#7a0000' },
      bg:{ url:'', size:'cover' },
      chipsTransparent:false
    };
    try{ return Object.assign(def, JSON.parse(localStorage.getItem(PREFS_KEY)||'{}')); }
    catch{ return def; }
  }
  function savePrefs(p){ localStorage.setItem(PREFS_KEY, JSON.stringify(p)); }
  function applyPrefs(p){
    const tones = {
      parchment: ['#f2eee6','#ebe4d7','#e5dccb'],
      crisp:     ['#fffefd','#f7f7f7','#efefef'],
      lavender:  ['#f6eef6','#efe1f0','#e7d6ea'],
      moss:      ['#f0f4ef','#e1eadf','#d2dfcf']
    };
    const C = tones[p.paper] || tones.parchment;
    const root = document.documentElement.style;
    root.setProperty('--paper',  C[0]);
    root.setProperty('--paper-2',C[1]);
    root.setProperty('--paper-3',C[2]);
    root.setProperty('--sheet', '#fffdfa');
    root.setProperty('--line',  'rgba(0,0,0,.12)');
    root.setProperty('--noise', p.bg?.url ? 0 : (p.noise ?? .08));
    root.setProperty('--serif', p.serif);
    root.setProperty('--mono',  p.mono);
    root.setProperty('--ink',    p.colors?.ink    || '#111111');
    root.setProperty('--accent', p.colors?.accent || '#b40000');
    root.setProperty('--red',    p.colors?.red    || '#7a0000');

    // Font scaling
    if(p.font==='sm'){ root.setProperty('--fs-11','0.625rem'); root.setProperty('--fs-13','0.75rem'); root.setProperty('--fs-15','0.875rem'); root.setProperty('--fs-18','1rem'); }
    else if(p.font==='lg'){ root.setProperty('--fs-11','0.75rem'); root.setProperty('--fs-13','0.875rem'); root.setProperty('--fs-15','1rem'); root.setProperty('--fs-18','1.25rem'); }
    else { root.setProperty('--fs-11','0.6875rem'); root.setProperty('--fs-13','0.8125rem'); root.setProperty('--fs-15','0.9375rem'); root.setProperty('--fs-18','1.125rem'); }

    // Editor rules
    const rule = p.lines || 'unruled';
    let bg = 'none', bsz='auto';
    const rc = 'var(--rule-color)';
    if(rule==='lined'){ bg = `repeating-linear-gradient(#fffdfa, #fffdfa 28px, ${rc} 28px, ${rc} 29px)`; }
    else if(rule==='dots'){ bg = `radial-gradient(${rc} 1px, transparent 1px)`; bsz = '18px 18px'; }
    else if(rule==='grid'){ bg = `linear-gradient(${rc} 1px, transparent 1px), linear-gradient(90deg, ${rc} 1px, transparent 1px)`; bsz = '20px 20px'; }
    root.setProperty('--editor-bg', bg);
    root.setProperty('--editor-bg-size', bsz);

    // Background image
    const url = (p.bg?.url||'').trim();
    root.setProperty('--bg-image', url ? `url("${url.replace(/"/g,'\\"')}")` : 'none');
    root.setProperty('--bg-size', p.bg?.size || 'cover');
    document.body.classList.toggle('bg-image-on', !!url);

    // Chip transparency
    root.setProperty('--chip-alpha', p.chipsTransparent ? .12 : 1);
    document.body.classList.toggle('chips-translucent', !!p.chipsTransparent);
  }

  /* ---------- Prefs UI wiring ---------- */
  function syncPrefsForm(p){
    els.prefPaper.value = p.paper || 'parchment';
    els.prefLines.value = p.lines || 'unruled';
    els.prefFont.value  = p.font  || 'md';
    els.prefSerif.value = p.serif || '';
    els.prefMono.value  = p.mono  || '';
    els.prefInk.value   = p.colors?.ink    || '#111111';
    els.prefAccent.value= p.colors?.accent || '#b40000';
    els.prefRed.value   = p.colors?.red    || '#7a0000';
    els.prefNoise.value = String(p.noise ?? .08);
    els.prefBgUrl.value = p.bg?.url || '';
    els.prefBgSize.value= p.bg?.size || 'cover';
  }
  function readPrefsForm(){
    return {
      paper: els.prefPaper.value,
      lines: els.prefLines.value,
      font:  els.prefFont.value,
      serif: els.prefSerif.value || "Georgia, 'Times New Roman', serif",
      mono:  els.prefMono.value  || "ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace",
      noise: Number(els.prefNoise.value || .08),
      colors:{
        ink: els.prefInk.value || '#111111',
        accent: els.prefAccent.value || '#b40000',
        red: els.prefRed.value || '#7a0000'
      },
      bg:{
        url: (els.prefBgUrl.value||'').trim(),
        size: els.prefBgSize.value || 'cover'
      },
      chipsTransparent: !!loadPrefs().chipsTransparent
    };
  }
  els.prefsBtn.addEventListener('click', ()=>{ const p=loadPrefs(); syncPrefsForm(p); els.prefsMenu.classList.add('open'); });
  els.prefCancel.addEventListener('click', ()=> els.prefsMenu.classList.remove('open'));
  els.prefSave.addEventListener('click', ()=>{
    const p = readPrefsForm(); savePrefs(p); applyPrefs(p);
    els.chipTransparent.checked = !!p.chipsTransparent;
    els.prefsMenu.classList.remove('open');
  });
  els.prefReset.addEventListener('click', ()=>{
    localStorage.removeItem(PREFS_KEY);
    const p = loadPrefs(); applyPrefs(p); syncPrefsForm(p);
    els.chipTransparent.checked = !!p.chipsTransparent;
    alert('Preferences reset.');
  });
  els.themeExport.addEventListener('click', ()=> download('synapsing_theme.json', new Blob([JSON.stringify(loadPrefs(),null,2)], {type:'application/json'})));
  els.themeImportBtn.addEventListener('click', ()=> els.themeImport.click());
  els.themeImport.addEventListener('change', async ()=>{
    const f = els.themeImport.files[0]; if(!f) return;
    try{
      const p = JSON.parse(await f.text());
      const merged = Object.assign(loadPrefs(), p || {});
      savePrefs(merged); applyPrefs(merged); syncPrefsForm(merged);
      els.chipTransparent.checked = !!merged.chipsTransparent;
      alert('Theme imported.');
    }catch(err){ alert('Invalid theme JSON'); }
    els.themeImport.value = '';
  });
  els.prefBgClear.addEventListener('click', ()=>{
    const p = loadPrefs(); p.bg = { url:'', size:'cover' };
    savePrefs(p); applyPrefs(p); syncPrefsForm(p);
  });

  // Download whole app
  els.downloadApp?.addEventListener('click', (e)=>{
    e.preventDefault();
    const dt = document.doctype ? new XMLSerializer().serializeToString(document.doctype) : '<!DOCTYPE html>';
    const html = document.documentElement.outerHTML;
    download('synaps.ing.html', new Blob([dt + '\n' + html], {type:'text/html'}));
  });

  /* ---------- Load & initial data ---------- */
  function loadAll(){
    try{
      const raw = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
      state.notes = raw.notes || [];
      state.stacks = raw.stacks || [];
    }catch{
      state.notes = []; state.stacks = [];
    }
    if(state.stacks.length===0) state.stacks = ['Inbox'];
    if(state.notes.length===0){
      const n = createNote({
        title:'Welcome',
        stack:'Inbox',
        tags:['getting-started'],
        content:`# Welcome

Link with [[First Idea]] (sibling) or create subnote >>Next Steps>>.`
      }, true);
      state.currentId = n.id;
      saveAll();
    }
    if(!state.selectedStack) state.selectedStack = getNote(state.currentId)?.stack || state.stacks[0];
  }

  /* ---------- Rendering ---------- */
  function populateTopbarStackSelector(){
    els.stackSelector.innerHTML = state.stacks
      .map(s=> `<option value="${escapeHTML(s)}"${s===state.selectedStack?' selected':''}>${escapeHTML(s)}</option>`)
      .join('');
  }
  function populateMetaStackSelect(currentNote){
    els.stackSelectMeta.innerHTML = state.stacks
      .map(s=> `<option value="${escapeHTML(s)}"${s===(currentNote?.stack||'Inbox')?' selected':''}>${escapeHTML(s)}</option>`)
      .join('');
  }
  function populateParentSelect(currentNote){
    const cur = currentNote;
    if(!cur){ els.parentSelectMeta.innerHTML = `<option value="">Top level</option>`; return; }

    // prevent cycles: exclude self & descendants; allow same-stack only
    const banned = new Set([cur.id]);
    (function walk(pid){
      listChildren(pid).forEach(ch=>{ banned.add(ch.id); walk(ch.id); });
    })(cur.id);

    const candidates = listByStack(cur.stack).filter(n => !banned.has(n.id));
    const opts = [`<option value="">Top level</option>`]
      .concat(candidates.map(n=> `<option value="${n.id}"${n.id===cur.parentId?' selected':''}>${escapeHTML(n.title)}</option>`));
    els.parentSelectMeta.innerHTML = opts.join('');
  }

  function switchToStack(stackName){
    if(!state.stacks.includes(stackName)) return;
    state.selectedStack = stackName;
    populateTopbarStackSelector();
    const list = listByStack(stackName);
    if(list.length) setActiveNote(list[0].id);
    renderAllStacksBar();
    refreshBreadcrumb();
  }

  function setActiveNote(nid){
    const n = getNote(nid); if(!n) return;
    state.currentId = n.id; state.selectedStack = state.selectedStack || n.stack;

    // editor fields
    els.titleInput.value = n.title;
    els.tagsInput.value  = (n.tags||[]).join(', ');
    els.md.value = n.content||'';

    // meta selects
    populateMetaStackSelect(n);
    populateParentSelect(n);

    // meta chips/front
    els.createdMeta.textContent = fmt(n.created);
    els.modifiedMeta.textContent = fmt(n.modified);
    els.frontTitle.value = n.title;
    els.frontId.textContent = hierarchicalId(n);
    els.chipStack.textContent = `stack: ${n.stack||'Inbox'}`;
    els.chipCreated.textContent = `created: ${fmt(n.created)}`;
    els.chipModified.textContent = `modified: ${fmt(n.modified)}`;
    els.chipTags.innerHTML = (n.tags||[]).map(t=>`<span class="chip">#${escapeHTML(t)}</span>`).join('') || '<span class="subtle" style="font-size:var(--fs-11)">no tags</span>';

    populateTopbarStackSelector();
    renderAllStacksBar();
    refreshBreadcrumb();
    refreshHierarchy();
  }

  // Query parsing & filter application
  function parseQuery(q){
    const parts = q.trim().match(/(?:[^\s"]+|"[^"]*")+/g) || [];
    const res = { tag:[], contains:[], title:[], stack:[], id:[], free:[] };
    parts.forEach(tok=>{
      const t = tok.replace(/^"|"$/g,'');
      const m = t.match(/^(tag|contains|title|stack|id):(.*)$/i);
      if(m){
        const k = m[1].toLowerCase(); const v = m[2].trim();
        if(!v) return; if(Array.isArray(res[k])) res[k].push(v.toLowerCase());
      }else{ res.free.push(t.toLowerCase()); }
    });
    return res;
  }
  function matchesQuery(note, qobj){
    if(qobj.tag.length      && !qobj.tag.every(t=> (note.tags||[]).some(x=>x.toLowerCase().includes(t)))) return false;
    if(qobj.contains.length && !qobj.contains.every(t=> (note.content||'').toLowerCase().includes(t))) return false;
    if(qobj.title.length    && !qobj.title.every(t=> (note.title||'').toLowerCase().includes(t))) return false;
    if(qobj.stack.length    && !qobj.stack.every(t=> (note.stack||'').toLowerCase().includes(t))) return false;
    if(qobj.id.length){
      const hid = hierarchicalId(note).toLowerCase();
      if(!qobj.id.every(t=> hid.startsWith(t))) return false;
    }
    if(qobj.free.length){
      const hay = ((note.title||'')+' '+(note.tags||[]).join(' ')+' '+(note.content||'')).toLowerCase();
      if(!qobj.free.every(t=> hay.includes(t))) return false;
    }
    return true;
  }
  function currentQueryMatches(){
    const q = els.search.value || '';
    const qobj = parseQuery(q);
    const isEmpty = !q || (
      Object.keys(qobj).every(k => Array.isArray(qobj[k]) ? qobj[k].length===0 : !qobj[k].length)
    );
    if(isEmpty) return new Set(state.notes.map(n=>n.id));
    return new Set(state.notes.filter(n=>matchesQuery(n,qobj)).map(n=>n.id));
  }

  function renderAllStacksBar(){
    const row = els.stacksRow;
    row.innerHTML = '';
    row.classList.add('scroll-minimal');

    const qMatches = currentQueryMatches();
    const filtering = state.filterMode;

    const prefs = loadPrefs();
    const CHIP_H = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--chip-h')) || 28;
    const OFFSET = prefs.chipsTransparent ? 24 : 18;

    state.stacks.forEach(stackName=>{
      const col = document.createElement('div');
      col.className = 'stack-col';
      col.dataset.stack = stackName;

      const list = listByStack(stackName);
      col.innerHTML = `
        <div class="shead">
          <span class="stitle" title="${escapeHTML(stackName)}">${escapeHTML(stackName)}</span>
          <span class="count">${list.length}</span>
        </div>
        <div class="pile scroll-minimal"></div>`;
      const pile = col.querySelector('.pile');
      const titleSpan = col.querySelector('.stitle');

      // Switch to stack by dblclicking column background (and reflect in top bar)
      col.addEventListener('dblclick', (ev)=>{ if(!ev.target.closest('.stitle')) switchToStack(stackName); });

      // Inline rename
      titleSpan.addEventListener('dblclick', (ev)=>{
        ev.stopPropagation();
        const oldName = stackName;
        const input = document.createElement('input');
        input.className = 'stack-title-input';
        input.value = oldName;
        titleSpan.replaceWith(input);
        input.focus(); input.select();

        function commit(newName){
          newName = (newName||'').trim();
          if(!newName || newName===oldName){ renderAllStacksBar(); return; }
          if(state.stacks.includes(newName)){ alert('A stack with this name already exists.'); renderAllStacksBar(); return; }
          state.stacks = state.stacks.map(s=> s===oldName ? newName : s);
          state.notes.forEach(n=>{ if(n.stack===oldName) n.stack = newName; });
          if(state.selectedStack===oldName) state.selectedStack = newName;
          saveAll(); populateTopbarStackSelector(); renderAllStacksBar(); refreshBreadcrumb();
          // also update meta stack select for current note
          populateMetaStackSelect(getNote(state.currentId));
        }
        input.addEventListener('keydown',(e)=>{
          if(e.key==='Enter'){ e.preventDefault(); commit(input.value); }
          if(e.key==='Escape'){ e.preventDefault(); renderAllStacksBar(); }
        });
        input.addEventListener('blur', ()=> commit(input.value));
      });

      // Depth-first chips
      const order = [];
      function dfs(note, depth){ order.push({note, depth}); listChildren(note.id).forEach(child=> dfs(child, depth+1)); }
      listTopLevel(stackName).forEach(n=> dfs(n, 0));

      const totalItems = filtering ? order.filter(it => qMatches.has(it.note.id)).length : order.length;

      const sizer = document.createElement('div');
      sizer.className = 'pile-sizer';
      sizer.style.height = Math.max(0, (totalItems - 1) * OFFSET + CHIP_H) + 'px';
      pile.appendChild(sizer);

      let visibleCount = 0;
      order.forEach((item, i)=>{
        const note = item.note;
        const isMatch = qMatches.has(note.id);
        if(filtering && !isMatch) return;

        const chip = document.createElement('div');
        chip.className = 'note-chip depth-'+Math.min(item.depth,3)+(note.id===state.currentId?' active':'');
        chip.draggable = true;
        chip.dataset.nid = note.id;
        const topIndex = filtering ? visibleCount : i;
        chip.style.top = (topIndex * OFFSET) + 'px';
        chip.innerHTML = `<span class="title" title="${escapeHTML(note.title)}">${escapeHTML(note.title)}</span><span class="hid">${escapeHTML(hierarchicalId(note))}</span>`;

        chip.addEventListener('click', ()=> setActiveNote(note.id));
        if(!filtering && !isMatch) chip.style.opacity='.35';
        pile.appendChild(chip);
        visibleCount++;

        // Drag
        chip.addEventListener('dragstart', (e)=>{
          chip.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', note.id);
        });
        chip.addEventListener('dragend', ()=> chip.classList.remove('dragging'));

        // Drop onto chip → sibling after
        chip.addEventListener('dragenter', (e)=>{ e.preventDefault(); chip.classList.add('drop-target'); });
        chip.addEventListener('dragover',  (e)=>{ e.preventDefault(); e.dataTransfer.dropEffect='move'; });
        chip.addEventListener('dragleave', ()=> chip.classList.remove('drop-target'));
        chip.addEventListener('drop', (e)=>{
          e.preventDefault(); chip.classList.remove('drop-target');
          const srcId = e.dataTransfer.getData('text/plain'); if(!srcId || srcId===note.id) return;
          const src = getNote(srcId); if(!src) return;

          let newParent = note.parentId;
          if (newParent === src.id) newParent = src.parentId || null;

          const newStack = note.stack;
          const newOrder = Number.isFinite(note.order) ? (note.order + 0.5) : nextOrderFor(newParent, newStack);

          updateNote(src.id, { stack:newStack, parentId:newParent, order:newOrder });
          renumberGroup(newParent, newStack);
          setActiveNote(src.id);
          renderAllStacksBar(); refreshBreadcrumb(); refreshHierarchy();
        });
      });

      // Column drop → move to this stack as top-level
      const enter = (e)=>{ e.preventDefault(); col.classList.add('drop-target'); };
      const over  = (e)=>{ e.preventDefault(); e.dataTransfer.dropEffect='move'; };
      const leave = ()=>{ col.classList.remove('drop-target'); };
      const drop  = (e)=>{
        e.preventDefault(); col.classList.remove('drop-target');
        const nid = e.dataTransfer.getData('text/plain'); if(!nid) return;
        const note = getNote(nid); if(!note || note.stack === stackName) return;
        updateNote(note.id, { stack: stackName, parentId: null, order: nextOrderFor(null, stackName) });
        setActiveNote(note.id);
      };
      col.addEventListener('dragenter', enter);
      col.addEventListener('dragover', over);
      col.addEventListener('dragleave', leave);
      col.addEventListener('drop', drop);

      // Fade hints
      function updatePileFades(el){
        const atTop = el.scrollTop <= 0;
        const atBottom = el.scrollTop + el.clientHeight >= el.scrollHeight - 1;
        el.classList.remove('scrolled-top','scrolled-mid','scrolled-bottom');
        if(atTop && !atBottom) el.classList.add('scrolled-top');
        else if(atBottom && !atTop) el.classList.add('scrolled-bottom');
        else if(!atTop && !atBottom) el.classList.add('scrolled-mid');
      }
      pile.addEventListener('scroll', ()=> updatePileFades(pile));
      queueMicrotask(()=> updatePileFades(pile));

      row.appendChild(col);
    });
  }

  function refreshBreadcrumb(){
    const cur = getNote(state.currentId); if(!cur) return;
    const parts = (cur.stack||'Inbox').split('/').map(s=>s.trim()).filter(Boolean);
    els.breadcrumb.innerHTML = '';
    let path = '';
    parts.forEach((p,i)=>{
      path = (i===0)?p:(path+' / '+p);
      const span = document.createElement('span');
      span.className = 'crumb'; span.textContent = p;
      span.addEventListener('click', ()=>{
        state.selectedStack = path;
        populateTopbarStackSelector(); renderAllStacksBar();
        const list = listByStack(path); if(list.length) setActiveNote(list[0].id);
      });
      els.breadcrumb.appendChild(span);
    });
  }

  function extractLinks(text){
    const wiki = Array.from(text.matchAll(/\[\[([^\]]+?)\]\]/g)).map(m=>m[1].trim()).filter(Boolean);
    const subs = Array.from(text.matchAll(/(?:>>|&gt;&gt;)\s*([^>]+?)\s*(?:>>|&gt;&gt;)/g)).map(m=>m[1].trim()).filter(Boolean);
    return { wiki, subs };
  }
  function refreshHierarchy(){
    const cur = getNote(state.currentId); if(!cur) return;
    const { wiki:outWiki, subs:outSubs } = extractLinks(els.md.value);

    const inbound = [];
    state.notes.forEach(n=>{
      if(n.id===cur.id) return;
      const { wiki } = extractLinks(n.content||'');
      if(wiki.includes(cur.title)) inbound.push(n);
    });
    if(cur.parentId){
      const parent = getNote(cur.parentId);
      if(parent && !inbound.find(x=>x.id===parent.id)) inbound.unshift(parent);
    }

    const children = listChildren(cur.id);

    if(outWiki.length===0 && outSubs.length===0 && inbound.length===0 && children.length===0){
      els.hierarchy.innerHTML = '<div class="subtle" style="font-size:var(--fs-11)">No links yet.</div>';
      return;
    }
    const linkSpan = (n)=> `<span class="link" data-nid="${n.id}" title="${escapeHTML(n.title)}">${escapeHTML(n.title)}</span>`;
    const outList = outWiki.map(t=>`<div>• <span class="link" data-title="${escapeHTML(t)}">${escapeHTML(t)}</span></div>`).join('');
    const subList = outSubs.map(t=>`<div>• <span class="link" data-title="${escapeHTML(t)}" data-kind="sub">${escapeHTML(t)}</span></div>`).join('');
    const inList  = inbound.map(n=>`<div>• ${linkSpan(n)} <span style="opacity:.7">(${escapeHTML(n.stack)})</span></div>`).join('');
    const kidsList= children.map(n=>`<div>• ${linkSpan(n)} <span style="opacity:.7">(subnote)</span></div>`).join('');

    els.hierarchy.innerHTML =
      (outList? `<div style="margin-bottom:.35rem"><strong>links out</strong></div>${outList}`:'') +
      (subList? `<div style="margin:.6rem 0 .35rem"><strong>subnotes</strong></div>${subList}`:'') +
      (inList?  `<div style="margin:.6rem 0 .35rem"><strong>links in</strong></div>${inList}`:'') +
      (kidsList?`<div style="margin:.6rem 0 .35rem"><strong>children</strong></div>${kidsList}`:'');
  }

  /* ---------- Link disambiguation popover (kept) ---------- */
  function openLinkPicker(anchorEl, choices, extras){
    const box = els.linkPicker;
    const items = [
      ...choices.map(c => `<div class="menu-item" data-nid="${c.id}">${escapeHTML(c.title)} <span style="opacity:.7">(${escapeHTML(c.stack)})</span></div>`),
      ...(extras||[]).map((x,i)=> `<div class="menu-item" data-extra="${i}">${escapeHTML(x.label)}</div>`)
    ];
    box.innerHTML = items.length ? items.join('') : '<div class="menu-item" style="opacity:.6;cursor:default">No matches</div>';

    const r = anchorEl.getBoundingClientRect();
    box.style.top  = (r.bottom + 6) + 'px';
    box.style.left = (r.left) + 'px';
    box.classList.add('open');

    function onDoc(e){
      if(e.target.closest('#linkPicker')) return (document.addEventListener('click', onDoc, {once:true}));
      box.classList.remove('open');
    }
    document.addEventListener('click', onDoc, {once:true});

    box.onclick = (e)=>{
      const extra = e.target.closest('[data-extra]');
      const pick  = e.target.closest('[data-nid]');
      if(extra){
        const i = Number(extra.getAttribute('data-extra'));
        const act = (extras||[])[i];
        box.classList.remove('open');
        if(act && typeof act.onClick==='function') act.onClick();
        return;
      }
      if(pick){
        const nid = pick.getAttribute('data-nid');
        box.classList.remove('open');
        setActiveNote(nid);
      }
    };
  }

  /* ---------- Export / Import ---------- */
  function mdFromNote(n){
    const t = (Array.isArray(n.tags)? n.tags.join(', '): (n.tags||''));
    return `---\ntitle: ${n.title}\ncreated: ${n.created}\nmodified: ${n.modified}\nstack: ${n.stack}\ntags: ${t}\n---\n\n${n.content||''}\n`;
  }
  function buildZip(files){
    function crc32(buf){ let c = ~0; for(let i=0;i<buf.length;i++){ c = (c>>>8) ^ table[(c ^ buf[i]) & 0xff]; } return ~c >>> 0; }
    const table = (function(){ const t=[]; for(let n=0;n<256;n++){ let c=n; for(let k=0;k<8;k++) c = (c & 1) ? (0xEDB88320 ^ (c>>>1)) : (c>>>1); t[n]=c>>>0; } return t; })();
    const encoder = new TextEncoder();
    const chunks = []; const central = []; let offset = 0;

    files.forEach(f=>{
      const nameBytes = encoder.encode(f.name);
      const dataBytes = encoder.encode(f.data);
      const crc = crc32(dataBytes);
      const size = dataBytes.length;
      const lh = new Uint8Array(30 + nameBytes.length);
      const dv = new DataView(lh.buffer);
      dv.setUint32(0, 0x04034b50, true);
      dv.setUint16(4, 20, true); dv.setUint16(6, 0, true); dv.setUint16(8, 0, true);
      dv.setUint16(10, 0, true); dv.setUint16(12, 0, true);
      dv.setUint32(14, crc, true);
      dv.setUint32(18, size, true); dv.setUint32(22, size, true);
      dv.setUint16(26, nameBytes.length, true); dv.setUint16(28, 0, true);
      lh.set(nameBytes, 30);
      chunks.push(lh, dataBytes);
      const localHeaderOffset = offset;
      offset += lh.length + dataBytes.length;

      const ch = new Uint8Array(46 + nameBytes.length);
      const cdv = new DataView(ch.buffer);
      cdv.setUint32(0, 0x02014b50, true);
      cdv.setUint16(4, 20, true); cdv.setUint16(6, 20, true);
      cdv.setUint16(8, 0, true); cdv.setUint16(10, 0, true);
      cdv.setUint16(12, 0, true); cdv.setUint16(14, 0, true);
      cdv.setUint32(16, crc, true); cdv.setUint32(20, size, true); cdv.setUint32(24, size, true);
      cdv.setUint16(28, nameBytes.length, true); cdv.setUint16(30, 0, true);
      cdv.setUint16(32, 0, true); cdv.setUint16(34, 0, true);
      cdv.setUint16(36, 0, true); cdv.setUint32(38, 0, true);
      cdv.setUint32(42, localHeaderOffset, true);
      central.push(ch);
    });

    const centralStart = offset;
    central.forEach(c => { chunks.push(c); offset += c.length; });
    const centralSize = offset - centralStart;

    const end = new Uint8Array(22);
    const edv = new DataView(end.buffer);
    edv.setUint32(0, 0x06054b50, true);
    edv.setUint16(4, 0, true); edv.setUint16(6, 0, true);
    edv.setUint16(8, files.length, true); edv.setUint16(10, files.length, true);
    edv.setUint32(12, centralSize, true); edv.setUint32(16, centralStart, true);
    edv.setUint16(20, 0, true);
    chunks.push(end);

    let total = 0; chunks.forEach(b=> total += b.length);
    const out = new Uint8Array(total);
    let off = 0; chunks.forEach(b=>{ out.set(b, off); off += b.length; });
    return new Blob([out], {type:'application/zip'});
  }

  function openModal(m){ m.classList.add('open'); }
  function closeModal(m){ m.classList.remove('open'); }

  els.exportBtn.addEventListener('click', ()=> openModal(els.exportMenu));
  els.expCancel.addEventListener('click', ()=> closeModal(els.exportMenu));
  els.expGo.addEventListener('click', ()=>{
    const fmtSel = document.querySelector('input[name="expfmt"]:checked').value;
    const scope  = document.querySelector('input[name="expscope"]:checked').value;
    const safe   = !!els.expSafe.checked;
    const stacks = scope==='current' ? [state.selectedStack] : state.stacks.slice();
    const notes  = state.notes.filter(n=> stacks.includes(n.stack));
    const stamp  = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');

    if(fmtSel==='json'){
      const data = { version: VERSION, exportedAt: nowISO(), stacks, notes };
      download(safeName(`synapsing_notebook_${scope}_${stamp}.json`, safe), new Blob([JSON.stringify(data,null,2)], {type:'application/json'}));
    }else{
      const files = [];
      notes.forEach(n=>{
        const safeStack = safeName(n.stack||'Inbox', safe) || 'Inbox';
        const safeTitle = safeName((n.title||'Untitled').slice(0,64), safe) || 'Untitled';
        files.push({ name: `${safeStack}/${safeTitle}.md`, data: mdFromNote(n) });
      });
      const zip = buildZip(files);
      download(safeName(`synapsing_markdown_${scope}_${stamp}.zip`, safe), zip);
    }
    closeModal(els.exportMenu);
  });

  els.importBtn.addEventListener('click', ()=> els.importInput.click());
  els.importInput.addEventListener('change', async ()=>{
    const file = els.importInput.files[0]; if(!file) return;
    try{
      const text = await f.text();
    }catch{}
    try{
      const text = await file.text();
      const data = JSON.parse(text);
      if(!Array.isArray(data.notes) || !Array.isArray(data.stacks)) throw new Error('Invalid notebook JSON.');
      const replace = confirm('Import will REPLACE your current notebook. Continue?');
      if(!replace) return;

      state.notes = data.notes.map(n=>({
        id: n.id || uid(),
        title: n.title||'Untitled',
        content: n.content||'',
        created: n.created || nowISO(),
        modified: n.modified || n.created || nowISO(),
        stack: n.stack || 'Inbox',
        tags: parseTags(n.tags||[]),
        parentId: n.parentId || null,
        order: Number.isFinite(n.order)? n.order : 0
      }));
      state.stacks = (data.stacks.length? data.stacks : ['Inbox']);
      stacksUnique(); saveAll();

      state.stacks.forEach(s => { renumberGroup(null, s); listByStack(s).forEach(n => renumberGroup(n.id, s)); });

      state.selectedStack = state.stacks[0];
      const first = listByStack(state.selectedStack)[0] || state.notes[0];
      if(first) setActiveNote(first.id);
      els.importInput.value = '';
      alert('Import complete.');
    }catch(err){
      console.error(err); alert('Import failed: ' + err.message);
    }
  });

  /* ---------- Editor interactions ---------- */
  let autosaveTimer=null, isDirty=false;
  function markDirty(){ isDirty=true; clearTimeout(autosaveTimer); autosaveTimer=setTimeout(()=>handleSave(), 900); }
  function insertBetween(ta,pos,left,right){
    const v = ta.value;
    ta.value = v.slice(0,pos)+left+right+v.slice(pos);
    const caret = pos+left.length; ta.selectionStart=ta.selectionEnd=caret; ta.focus();
  }
  els.md.addEventListener('keydown', (e)=>{
    const ta = els.md; const pos = ta.selectionStart;
    if(e.key==='['){ e.preventDefault(); insertBetween(ta,pos,'[[',']]'); return; }
    if(e.key==='>'){ e.preventDefault(); insertBetween(ta,pos,'>>','>>'); return; }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); handleSave(); }
  });
  els.md.addEventListener('input', refreshHierarchy);

  // live chip reflection
  id('frontTitle').addEventListener('input', ()=>{ els.titleInput.value = id('frontTitle').value; markDirty(); });
  els.titleInput.addEventListener('input', ()=>{
    id('frontTitle').value = els.titleInput.value;
    markDirty();
  });
  els.tagsInput.addEventListener('input', ()=>{
    const tags = parseTags(els.tagsInput.value);
    id('chipTags').innerHTML = tags.length ? tags.map(t=>`<span class="chip">#${escapeHTML(t)}</span>`).join('') : '<span class="subtle" style="font-size:var(--fs-11)">no tags</span>';
    markDirty();
  });

  // Meta selects events
  els.stackSelectMeta.addEventListener('change', ()=>{
    // When note's stack changes in meta, swap chips preview and reset parent to Top level
    const s = els.stackSelectMeta.value || 'Inbox';
    id('chipStack').textContent = `stack: ${s}`;
    // rebuild parent list for that stack, default to Top level
    const cur = getNote(state.currentId);
    const fake = Object.assign({}, cur, { stack: s, parentId: null });
    populateParentSelect(fake);
    markDirty();
  });
  els.parentSelectMeta.addEventListener('change', ()=>{ markDirty(); });

  [els.md].forEach(el=>{
    el.addEventListener('input', markDirty);
    el.addEventListener('blur', ()=>{ if(isDirty) handleSave(); });
  });
  window.addEventListener('beforeunload', ()=>{ if(isDirty) handleSave(); });

  els.hierarchy.addEventListener('click', (e)=>{
    const nid = e.target.getAttribute('data-nid');
    if(nid){ setActiveNote(nid); return; }

    const el = e.target.closest('.link'); if(!el) return;
    const name = el.getAttribute('data-title'); if(!name) return;

    const isSub = el.getAttribute('data-kind') === 'sub';
    const cur = getNote(state.currentId); if(!cur) return;

    const candidates = state.notes.filter(n => n.title === name);

    function createHere(asChild){
      const nn = createNote({ title:name, stack:cur.stack, parentId: (asChild ? cur.id : null) });
      setActiveNote(nn.id);
    }

    if(candidates.length === 0){ return createHere(isSub); }
    if(candidates.length === 1){
      const target = candidates[0];
      if(isSub && target.stack === cur.stack && target.parentId !== cur.id){
        updateNote(target.id, { parentId: cur.id, order: nextOrderFor(cur.id, cur.stack) });
      }
      return setActiveNote(target.id);
    }

    const choiceData = candidates.map(n => ({ id:n.id, title:n.title, stack:n.stack }));
    const extras = isSub
      ? [
          { label:'Create here as child', onClick: ()=> createHere(true) },
          { label:'Create here (no parent)', onClick: ()=> createHere(false) }
        ]
      : [{ label:'Create here (new note)', onClick: ()=> createHere(false) }];

    openLinkPicker(el, choiceData, extras);
  });

  els.saveBtn.addEventListener('click', handleSave);
  function handleSave(){
    isDirty=false; clearTimeout(autosaveTimer);
    const n = getNote(state.currentId); if(!n) return;

    const newStack  = (els.stackSelectMeta.value||'Inbox').trim() || 'Inbox';
    const newParent = els.parentSelectMeta.value || null;

    const fields = {
      title: (els.titleInput.value||'Untitled').trim() || 'Untitled',
      stack: newStack,
      tags:  parseTags(els.tagsInput.value),
      content: els.md.value
    };

    if(newParent !== (n.parentId || null) || newStack !== n.stack){
      fields.parentId = newParent;
      fields.order = nextOrderFor(newParent, newStack);
    }

    const updated = updateNote(n.id, fields);

    id('frontTitle').value = updated.title;
    id('frontId').textContent = hierarchicalId(updated);
    id('chipStack').textContent = `stack: ${updated.stack||'Inbox'}`;
    id('chipCreated').textContent = `created: ${fmt(updated.created)}`;
    id('chipModified').textContent = `modified: ${fmt(updated.modified)}`;
    id('chipTags').innerHTML = (updated.tags||[]).map(t=>`<span class="chip">#${escapeHTML(t)}</span>`).join('') || '<span class="subtle" style="font-size:var(--fs-11)">no tags</span>';
    els.createdMeta.textContent = fmt(updated.created);
    els.modifiedMeta.textContent = fmt(updated.modified);

    populateTopbarStackSelector(); renderAllStacksBar(); refreshBreadcrumb(); refreshHierarchy();
    flash(els.saveBtn,'Saved');
  }

  // Note creation flows (top-bar stack is the source of truth for New Note)
  function createNewNote(){
    const cur = getNote(state.currentId);
    const targetStack = state.selectedStack || (cur?.stack || 'Inbox');

    if(cur && targetStack === cur.stack){
      // same stack as current note → sibling (inherit parent)
      const n = createNote({ stack: cur.stack, parentId: cur.parentId || null, title:'New Note' });
      setActiveNote(n.id);
    }else{
      // different stack chosen in top bar → top-level in that stack
      const n = createNote({ stack: targetStack, parentId: null, title:'New Note' });
      setActiveNote(n.id);
    }
  }
  els.newNoteBtn.addEventListener('click', createNewNote);

  els.duplicateBtn.addEventListener('click', ()=>{ const copy=duplicateNote(state.currentId); setActiveNote(copy.id); });

  els.deleteBtn.addEventListener('click', ()=>{
    const n = getNote(state.currentId); if(!n) return;
    if(!confirm('Delete this note and all its subnotes?')) return;
    const stack = n.stack;

    const ids = (function collect(rootId){
      const acc = [rootId];
      (function walk(pid){ listChildren(pid).forEach(ch=>{ acc.push(ch.id); walk(ch.id); }); })(rootId);
      return acc;
    })(n.id);

    state.notes = state.notes.filter(x=> !ids.includes(x.id));
    saveAll();

    const fallback = listByStack(stack)[0] || state.notes[0];
    if(fallback) setActiveNote(fallback.id); else { state.currentId=null; renderAllStacksBar(); }
  });

  els.exportNoteBtn.addEventListener('click', ()=>{
    const n = getNote(state.currentId); if(!n) return;
    download(safeName(`${n.stack}/${n.title}.md`, true).replace(/\//g,'__'), new Blob([mdFromNote(n)], {type:'text/markdown'}));
  });

  // Right-rail / topbar actions
  els.newNotebookBtn.addEventListener('click', ()=>{
    if(!confirm('Create a new empty notebook? This will REPLACE your current notebook. Continue?')) return;
    state.notes = []; state.stacks = ['Inbox'];
    const n = createNote({ title:'Welcome', stack:'Inbox', tags:['getting-started'], content:'# New Notebook\n\nStart writing…' }, true);
    state.currentId = n.id; state.selectedStack = 'Inbox'; saveAll();
    populateTopbarStackSelector(); renderAllStacksBar(); setActiveNote(state.currentId);
    alert('New notebook created.');
  });
  els.newSubBtn.addEventListener('click', ()=>{
    const cur = getNote(state.currentId); if(!cur) return;
    // Subnote always follows current note's context (stack & parent = current)
    const child = createNote({ stack: cur.stack, parentId: cur.id, title:'New Subnote' });
    setActiveNote(child.id);
  });

  function promptStackName(){
    let name = prompt('New stack name:', 'New Stack');
    if(!name) return null; name = name.trim(); if(!name) return null;
    if(state.stacks.includes(name)){ alert('Stack already exists.'); return null; }
    return name;
  }
  function addStackFlow(){
    const name = promptStackName(); if(!name) return;
    state.stacks.push(name); stacksUnique(); state.selectedStack = name; saveAll();
    populateTopbarStackSelector(); renderAllStacksBar();
    // Update meta dropdown for current note
    populateMetaStackSelect(getNote(state.currentId));
  }
  els.addStackBtn.addEventListener('click', addStackFlow);
  els.newStackBtn.addEventListener('click', addStackFlow);

  els.stackSelector.addEventListener('change', ()=> switchToStack(els.stackSelector.value));

  // Search & filter
  els.filterMode.addEventListener('change', ()=>{ state.filterMode = els.filterMode.checked; renderAllStacksBar(); });
  els.search.addEventListener('input', ()=> renderAllStacksBar());

  // Chip transparency -> prefs
  els.chipTransparent.addEventListener('change', ()=>{
    const p = loadPrefs(); p.chipsTransparent = !!els.chipTransparent.checked; savePrefs(p); applyPrefs(p);
    renderAllStacksBar();
  });

  // Shortcuts
  document.addEventListener('keydown', (e)=>{
    const mod = e.metaKey || e.ctrlKey;
    if(mod && e.key.toLowerCase()==='s'){ e.preventDefault(); handleSave(); }
    if(mod && e.key.toLowerCase()==='d'){ e.preventDefault(); const copy=duplicateNote(state.currentId); setActiveNote(copy.id); }
    if(mod && e.key.toLowerCase()==='e'){ e.preventDefault(); els.exportNoteBtn.click(); }
    if(mod && (e.key==='Backspace' || e.key==='Delete')){ e.preventDefault(); els.deleteBtn.click(); }
    if(mod && e.key.toLowerCase()==='f'){ e.preventDefault(); els.search.focus(); els.search.select(); }
    if(mod && e.shiftKey && e.key.toLowerCase()==='f'){ e.preventDefault(); els.filterMode.checked = !els.filterMode.checked; els.filterMode.dispatchEvent(new Event('change')); }
    if(mod && e.altKey && e.key.toLowerCase()==='t'){ e.preventDefault(); els.chipTransparent.checked = !els.chipTransparent.checked; els.chipTransparent.dispatchEvent(new Event('change')); }
    if(mod && e.key.toLowerCase()==='n'){ e.preventDefault(); createNewNote(); }
    if(mod && e.shiftKey && e.key.toLowerCase()==='n'){ e.preventDefault(); els.newSubBtn.click(); }
    if(mod && e.key.toLowerCase()==='p'){ e.preventDefault(); els.prefsBtn.click(); }
    if(mod && e.key.toLowerCase()==='x'){ e.preventDefault(); els.exportBtn.click(); }
  });

  // Indent/outdent within same stack
  document.addEventListener('keydown', (e)=>{
    if(!(e.metaKey||e.ctrlKey)) return;
    const cur = getNote(state.currentId); if(!cur) return;

    if(e.key === ']' ){
      const list = listByStack(cur.stack);
      const idx = list.findIndex(n=>n.id===cur.id);
      const prev = list[idx-1];
      if(prev && prev.id !== cur.parentId){
        e.preventDefault();
        updateNote(cur.id, { parentId: prev.id, order: nextOrderFor(prev.id, prev.stack) });
        setActiveNote(cur.id);
      }
    }
    if(e.key === '[' ){
      if(cur.parentId){
        e.preventDefault();
        updateNote(cur.id, { parentId:null, order: nextOrderFor(null, cur.stack) });
        setActiveNote(cur.id);
      }
    }
  });

  /* ---------- Boot ---------- */
  loadAll();
  (function init(){
    const p = loadPrefs(); applyPrefs(p);
    els.chipTransparent.checked = !!p.chipsTransparent;

    populateTopbarStackSelector();
    if(!state.currentId && state.notes[0]) state.currentId = state.notes[0].id;
    setActiveNote(state.currentId);
  })();

})();
</script>
</body>
</html>
